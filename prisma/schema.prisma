// Prisma Schema für Vertragscontrolling
// SQLite Datenbank für lokale Installation

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Benutzer
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  role          String    @default("USER") // ADMIN, USER, VIEWER
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  contracts     Contract[] @relation("CreatedBy")
  
  @@map("users")
}

// Vertragsarten
model ContractType {
  id        String     @id @default(cuid())
  name      String     @unique
  color     String     @default("#be004a")
  createdAt DateTime   @default(now())
  
  contracts Contract[]
  
  @@map("contract_types")
}

// Verträge
model Contract {
  id               String    @id @default(cuid())
  contractNumber   String    @unique
  title            String
  partner          String
  description      String?
  
  // Vertragsart
  typeId           String
  type             ContractType @relation(fields: [typeId], references: [id])
  
  // Laufzeiten
  startDate        DateTime
  endDate          DateTime?
  terminationDate  DateTime?      // Kündigungsfrist (legacy)
  noticePeriodDays Int       @default(30) // Kündigungsfrist in Tagen (legacy)
  
  // Finanzen
  value            Float?         // Vertragswert
  currency         String    @default("EUR")
  paymentInterval  String?        // monatlich, jährlich, einmalig
  
  // Status (ACTIVE, TERMINATED, EXPIRED, DRAFT)
  status           String    @default("ACTIVE")
  autoRenewal      Boolean   @default(false)
  
  // Notizen & Dokumente
  notes            String?
  documentPath     String?        // Pfad zum Vertragsdokument
  
  // Erinnerungen (legacy - wird durch Deadline ersetzt)
  reminderDays     Int       @default(30)
  reminderSent     Boolean   @default(false)
  
  // Fristen
  deadlines        Deadline[]
  
  // Kennzahlen
  kpis             ContractKpi[]
  
  // Metadaten
  createdById      String
  createdBy        User      @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  @@map("contracts")
}

// Fristen pro Vertrag
model Deadline {
  id              String    @id @default(cuid())
  contractId      String
  contract        Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  
  // Frist-Definition
  type            String    // KUENDIGUNG, VERLAENGERUNG, PRUEFUNG, RECHNUNG, SONSTIGES
  customLabel     String?   // Optionale benutzerdefinierte Bezeichnung
  
  // Fristdatum
  dueDate         DateTime
  
  // Benachrichtigung
  reminderDays    Int       @default(30) // 7, 14, 30, 90 Tage vor Frist
  notifyEmail     String?   // E-Mail-Adresse für Benachrichtigung
  
  // Status
  isCompleted     Boolean   @default(false)
  completedAt     DateTime?
  reminderSent    Boolean   @default(false)
  
  // Metadaten
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@map("deadlines")
}

// E-Mail Benachrichtigungen Log
model NotificationLog {
  id          String   @id @default(cuid())
  contractId  String
  type        String   // REMINDER, EXPIRY, etc.
  sentAt      DateTime @default(now())
  recipient   String
  success     Boolean
  
  @@map("notification_logs")
}

// Kennzahlen-Typen (Definition in Einstellungen)
model KpiType {
  id          String   @id @default(cuid())
  name        String   @unique
  dataType    String   // NUMBER, PERCENT, CURRENCY
  unit        String?  // z.B. "€", "%", "Stück"
  description String?
  color       String   @default("#3b82f6")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  contractKpis ContractKpi[]
  
  @@map("kpi_types")
}

// Kennzahlen pro Vertrag
model ContractKpi {
  id           String    @id @default(cuid())
  contractId   String
  contract     Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  kpiTypeId    String
  kpiType      KpiType   @relation(fields: [kpiTypeId], references: [id], onDelete: Cascade)
  
  // Werte
  targetValue  Float     // Zielwert
  currentValue Float     @default(0) // Aktueller Wert
  
  // Fristdatum für die Ampel-Logik
  dueDate      DateTime?
  
  // Metadaten
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  // Historie
  history      KpiHistory[]
  
  @@unique([contractId, kpiTypeId])
  @@map("contract_kpis")
}

// Historie der Kennzahlen-Änderungen
model KpiHistory {
  id            String      @id @default(cuid())
  contractKpiId String
  contractKpi   ContractKpi @relation(fields: [contractKpiId], references: [id], onDelete: Cascade)
  
  previousValue Float
  newValue      Float
  changedAt     DateTime    @default(now())
  changedBy     String?     // User-ID oder Name
  note          String?     // Optionale Notiz zur Änderung
  
  @@map("kpi_history")
}
